#! /usr/bin/env python3

import re
import emoji
#import opencc
import jieba


class TextRegularization:
    def __init__(self, isZh=True,isCut=False):
        self.isZh = isZh
        self.isCut=isCut


    def strtr(self,text, replace):
        for s, r in replace.items():
            text = text.replace(s, r)
        return text

    def stopWordCase(self,text):
        """
        å»æ‰åœç”¨è¯
        :param text:
        :return:
        """
        stopwords_dict = {
            '!': '',
            '.': '',
            ',': '',
            '#': '',
            '$': '',
            '%': '',
            '&': '',
            '*': '',
            '(': '',
            ')': '',
            '|': '',
            '?': '',
            '/': '',
            '@': '',
            '\'': '',
            '\'': '',
            ';': '',
            '[': '',
            ']': '',
            '{': '',
            '}': '',
            '+': '',
            '~': '',
            '-': '',
            '_': '',
            '=': '',
            '^': '',
            '<': '',
            '>': '',
            'ã€€': '',
            'ï¼': '',
            'ã€‚': '',
            'ï¼Œ': '',
            'ï¿¥': '',
            'ï¼ˆ': '',
            'ï¼‰': '',
            'ï¼Ÿ': '',
            'ã€': '',
            'â€œ': '',
            'â€˜': '',
            'ï¼›': '',
            'ã€': '',
            'ã€‘': '',
            'â€”â€”': '',
            'â€¦â€¦': '',
            'ã€Š': '',
            'ã€‹': ''
        }
        return self.strtr(text, stopwords_dict)

    # def simplify(self,text):
    #     converter = opencc.OpenCC('t2s')
    #     return converter.convert(text)

    # def traditionalize(text):
    #     """ https://pypi.python.org/pypi/OpenCC
    #     """
    #     return opencc.convert(text, config='s2t.json')

    def sbcCase(self,text):
        """è½¬æ¢å…¨è§’å­—ç¬¦ä¸ºåŠè§’å­—ç¬¦
        SBC case to DBC case
        """
        return self.strtr(text, {
            "ï¼": "0", "ï¼‘": "1", "ï¼’": "2", "ï¼“": "3", "ï¼”": "4",
            "ï¼•": "5", "ï¼–": "6", "ï¼—": "7", "ï¼˜": "8", "ï¼™": "9",
            'ï¼¡': 'A', 'ï¼¢': 'B', 'ï¼£': 'C', 'ï¼¤': 'D', 'ï¼¥': 'E',
            'ï¼¦': 'F', 'ï¼§': 'G', 'ï¼¨': 'H', 'ï¼©': 'I', 'ï¼ª': 'J',
            'ï¼«': 'K', 'ï¼¬': 'L', 'ï¼­': 'M', 'ï¼®': 'N', 'ï¼¯': 'O',
            'ï¼°': 'P', 'ï¼±': 'Q', 'ï¼²': 'R', 'ï¼³': 'S', 'ï¼´': 'T',
            'ï¼µ': 'U', 'ï¼¶': 'V', 'ï¼·': 'W', 'ï¼¸': 'X', 'ï¼¹': 'Y',
            'ï¼º': 'Z', 'ï½': 'a', 'ï½‚': 'b', 'ï½ƒ': 'c', 'ï½„': 'd',
            'ï½…': 'e', 'ï½†': 'f', 'ï½‡': 'g', 'ï½ˆ': 'h', 'ï½‰': 'i',
            'ï½Š': 'j', 'ï½‹': 'k', 'ï½Œ': 'l', 'ï½': 'm', 'ï½': 'n',
            'ï½': 'o', 'ï½': 'p', 'ï½‘': 'q', 'ï½’': 'r', 'ï½“': 's',
            'ï½”': 't', 'ï½•': 'u', 'ï½–': 'v', 'ï½—': 'w', 'ï½˜': 'x',
            'ï½™': 'y', 'ï½š': 'z',
        })

    def circleCase(self,text):
        """è½¬æ¢â‘ æ•°å­—ä¸ºåŠè§’æ•°å­—
        â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨â‘© case å…¨è§’
        â¹â¸â½â¼â½â¼â¾â½â¼
        â€ââ‚âƒâ„â…â†â‡âˆ
        """
        return self.strtr(text, {
            "â€": "1", "â": "2", "â‚": "3", "âƒ": "4", "â„": "5",
            "â…": "6", "â†": "7", "â‡": "8", "âˆ": "9", "â‘ ": "1",
            "â‘¡": "2", "â‘¢": "3", "â‘£": "4", "â‘¤": "5", "â‘¥": "6",
            "â‘¦": "7", "â‘§": "8", "â‘¨": "9", "â¶": "1", "â·": "2",
            "â¸": "3", "â¹": "4", "âº": "5", "â»": "6", "â¼": "7",
            "â½": "8", "â¾": "9", "âŠ": "1", "â‹": "2", "âŒ": "3",
            "â": "4", "â": "5", "â": "6", "â": "7", "â‘": "8",
            "â’": "9", 'â’¶': 'A', 'â’·': 'B', 'â’¸': 'C', 'â’¹': 'D',
            'â’º': 'E', 'â’»': 'F', 'â’¼': 'G', 'â’½': 'H', 'â’¾': 'I',
            'â’¿': 'J', 'â“€': 'K', 'â“': 'L', 'â“‚': 'M', 'â“ƒ': 'N',
            'â“„': 'O', 'â“…': 'P', 'â“†': 'Q', 'â“‡': 'R', 'â“ˆ': 'S',
            'â“‰': 'T', 'â“Š': 'U', 'â“‹': 'V', 'â“Œ': 'W', 'â“': 'X',
            'â“': 'Y', 'â“': 'Z', 'â“': 'a', 'â“‘': 'b', 'â“’': 'c',
            'â““': 'd', 'â“”': 'e', 'â“•': 'f', 'â“–': 'g', 'â“—': 'h',
            'â“˜': 'i', 'â“™': 'j', 'â“š': 'k', 'â“›': 'l', 'â“œ': 'm',
            'â“': 'n', 'â“': 'o', 'â“Ÿ': 'p', 'â“ ': 'q', 'â“¡': 'r',
            'â“¢': 's', 'â“£': 't', 'â“¤': 'u', 'â“¥': 'v', 'â“¦': 'w',
            'â“§': 'x', 'â“¨': 'y', 'â“©': 'z',
            "ãŠ€": "ä¸€", "ãŠ": "äºŒ", "ãŠ‚": "ä¸‰", "ãŠƒ": "å››",
            "ãŠ„": "äº”", "ãŠ…": "å…­", "ãŠ†": "ä¸ƒ", "ãŠ‡": "å…«",
            "ãŠˆ": "ä¹",
        })

    def bracketCase(self,text):
        """è½¬æ¢â‘´æ•°å­—ä¸ºåŠè§’æ•°å­—
        â‘´ â‘µ â‘¶ â‘· â‘¸ â‘¹ â‘º â‘» â‘¼case å…¨è§’
        """
        return self.strtr(text, {
            "â‘´": "1", "â‘µ": "2", "â‘¶": "3", "â‘·": "4", "â‘¸": "5",
            "â‘¹": "6", "â‘º": "7", "â‘»": "8", "â‘¼": "9",
            'ğŸ„': 'A', 'ğŸ„‘': 'B', 'ğŸ„’': 'C', 'ğŸ„“': 'D', 'ğŸ„”': 'E',
            'ğŸ„•': 'F', 'ğŸ„–': 'G', 'ğŸ„—': 'H', 'ğŸ„˜': 'I', 'ğŸ„™': 'J',
            'ğŸ„š': 'K', 'ğŸ„›': 'L', 'ğŸ„œ': 'M', 'ğŸ„': 'N', 'ğŸ„': 'O',
            'ğŸ„Ÿ': 'P', 'ğŸ„ ': 'Q', 'ğŸ„¡': 'R', 'ğŸ„¢': 'S', 'ğŸ„£': 'T',
            'ğŸ„¤': 'U', 'ğŸ„¥': 'V', 'ğŸ„¦': 'W', 'ğŸ„§': 'X', 'ğŸ„¨': 'Y',
            'ğŸ„©': 'Z', 'â’œ': 'a', 'â’': 'b', 'â’': 'c', 'â’Ÿ': 'd',
            'â’ ': 'e', 'â’¡': 'f', 'â’¢': 'g', 'â’£': 'h', 'â’¤': 'i',
            'â’¥': 'j', 'â’¦': 'k', 'â’§': 'l', 'â’¨': 'm', 'â’©': 'n',
            'â’ª': 'o', 'â’«': 'p', 'â’¬': 'q', 'â’­': 'r', 'â’®': 's',
            'â’¯': 't', 'â’°': 'u', 'â’±': 'v', 'â’²': 'w', 'â’³': 'x',
            'â’´': 'y', 'â’µ': 'z',
            "ãˆ ": "ä¸€", "ãˆ¡": "äºŒ", "ãˆ¢": "ä¸‰", "ãˆ£": "å››",
            "ãˆ¤": "äº”", "ãˆ¥": "å…­", "ãˆ¦": "ä¸ƒ", "ãˆ§": "å…«",
            "ãˆ¨": "ä¹",
        })

    def dotCase(self,text):
        """è½¬æ¢â‘´æ•°å­—ä¸ºåŠè§’æ•°å­—
        â’ˆâ’‰â’Šâ’‹â’Œâ’â’â’â’case å…¨è§’
        """
        return self.strtr(text, {
            "â’ˆ": "1",
            "â’‰": "2",
            "â’Š": "3",
            "â’‹": "4",
            "â’Œ": "5",
            "â’": "6",
            "â’": "7",
            "â’": "8",
            "â’": "9",
        })

    def specialCase(self,text):
        """ç‰¹æ®Šå­—ç¬¦æ¯”å¦‚å¸Œè…Šå­—ç¬¦ï¼Œè¥¿é‡Œå°”å­—æ¯
        """
        return self.strtr(text, {
            # å¸Œè…Šå­—æ¯
            "Î‘": "A", "Î’": "B", "Î•": "E", "Î–": "Z", "Î—": "H",
            "Î™": "I", "Îš": "K", "Îœ": "M", "Î": "N", "ÎŸ": "O",
            "Î¡": "P", "Î¤": "T", "Î§": "X", "Î±": "a", "Î²": "b",
            "Î³": "y", "Î¹": "l", "Îº": "k", "Î¼": "u", "Î½": "v",
            "Î¿": "o", "Ï": "p", "Ï„": "t", "Ï‡": "x",

            # è¥¿é‡Œå°”å­—æ¯ (U+0400 - U+04FF)
            "Ğ€": "E", "Ğ": "E", "Ğ…": "S", "Ğ†": "I", "Ğ‡": "I",
            "Ğˆ": "J", "ĞŒ": "K", "Ğ": "A", "Ğ’": "B", "Ğ•": "E",
            "Ğ—": "3", "Î–": "Z", "Ğ˜": "N", "Ğœ": "M", "Ğ": "H",
            "Ğ": "O", "Ğ ": "P", "Ğ¡": "C", "Ğ¢": "T", "Ğ£": "y",
            "Ğ¥": "X", "Ğ¬": "b", "Ğª": "b", "Ğ°": "a", "Ğ²": "B",
            "Ğµ": "e", "Ğº": "K", "Ğ¼": "M", "Ğ½": "H", "Ğ¾": "O",
            "Ğ¿": "n", "Ñ€": "P", "Ñ": "c", "Ñ‚": "T", "Ñƒ": "y",
            "Ñ…": "x", "Ñˆ": "w", "ÑŒ": "b", "Ñ•": "s", "Ñ–": "i",
            "Ñ˜": "j",

            "Ã€": "A", "Ã": "A", "Ã‚": "A", "Ãƒ": "A", "Ã„": "A", "Ã…": "A", "Ä€": "A", "Ä‚": "A", "Ä‚": "A",
            "Ã‡": "C", "Ä†": "C", "Äˆ": "C", "ÄŠ": "C",
            "Ã": "D", "Ä": "D", "Ä": "D",
            "Ãˆ": "E", "Ã‰": "E", "ÃŠ": "E", "Ã‹": "E", "Ä’": "E", "Ä–": "E", "Ä˜": "E", "Äš": "E",
            "Äœ": "G", "Ä ": "G", "Ä¢": "G",
            "Ä¤": "H", "Ä¦": "H",
            "ÃŒ": "I", "Ã": "I", "Ã®": "I", "Ã¯": "I", "Ä¯": "I",
            "Ä´": "J",
            "Ä¶": "K",
            "Ä»": "L", "Å": "L",
            "Ã‘": "N", "Åƒ": "N", "Å…": "N", "Å‡": "N",
            "Ã’": "O", "Ã“": "O", "Ã”": "O", "Ã•": "O", "Ã–": "O", "Å": "O",
            "Å”": "R", "Å˜": "R",
            "Åš": "S", "Åœ": "S", "Å": "S", "Å ": "S", "È˜": "S",
            "Å¢": "T", "Å¤": "T", "Èš": "T",
            "Ã™": "U", "Ãš": "U", "Ã›": "U", "Ãœ": "U", "Åª": "U", "Å¬": "U", "Å®": "U", "Å°": "U", "Å²": "U",
            "Å´": "W",
            "Ã": "Y", "Å¶": "Y", "Å¸": "Y",
            "Å¹": "Z", "Å»": "Z", "Å½": "Z",

            "Ã ": "a", "Ã¡": "a", "Ã¢": "a", "Ã£": "a", "Ã¤": "a", "Ã¥": "a", "Ä": "a", "Äƒ": "a", "Ä…": "a",
            "Ã§": "c", "Ä‡": "c", "Ä‰": "c", "Ä‹": "c",
            "Ä": "d", "Ä‘": "d",
            "Ã¨": "e", "Ã©": "e", "Ãª": "e", "Ã«": "e", "Ä“": "e", "Ä—": "e", "Ä™": "e", "Ä›": "e", "É™": "e",
            "Ä": "g", "Ä¡": "g", "Ä£": "g",
            "Ä¥": "h", "Ä§": "h",
            "Ã¬": "i", "Ã­": "i", "Ã®": "i", "Ã¯": "i", "Ä«": "i", "Ä¯": "i",
            "Äµ": "j",
            "Ä·": "k",
            "Ä¼": "l",
            "Ã±": "n", "Å„": "n", "Å†": "n", "Åˆ": "n",
            "Ã²": "o", "Ã³": "o", "Ã´": "o", "Ãµ": "o", "Ã¶": "o", "Å‘": "o", "Å•": "r", "Å™": "r",
            "Å›": "s", "Å": "s", "ÅŸ": "s", "Å¡": "s", "È™": "s",
            "Å£": "t", "Å¥": "t", "È›": "t",
            "Ã¹": "u", "Ãº": "u", "Ã»": "u", "Ã¼": "u", "Å«": "u", "Å­": "u", "Å¯": "u", "Å±": "u", "Å³": "u",
            "Åµ": "w",
            "Ã½": "y", "Å·": "y", "Ã¿": "y",
            "Åº": "z", "Å¼": "z", "Å¾": "z",

            # ç½—é©¬æ•°å­—Roman numerals
            "â… ": "I", "â…¡": "II", "â…¢": "III", "â…£": "IV", "â…¤": "V", "â…¥": "VI", "â…¦": "VII",
            "â…§": "VIII", "â…¨": "IX", "â…©": "X", "â…ª": "XI", "â…«": "XII", "â…¬": "L", "â…­": "C",
            "â…®": "D", "â…¯": "M",
            "â…°": "i", "â…±": "ii", "â…²": "iii", "â…³": "iv", "â…´": "v", "â…µ": "vi", "â…¶": "vii",
            "â…·": "viii", "â…¸": "ix", "â…¹": "x", "â…º": "xi", "â…»": "xii", "â…¼": "l", "â…½": "c",
            "â…¾": "d", "â…¿": "m",
        })

    def emojiCase(self,text, language='zh'):
        """
        è¾“å…¥ï¼šğŸš€ğŸŒ•
        è¾“å‡ºï¼šç«ç®­ï¼šæ»¡æœˆ
        """
        return emoji.demojize(text, language=language)

    def spaceCase(self,text):
        #å»ç©ºæ ¼
        regex = re.compile("\s+")
        text=re.sub(regex, " ", text.strip())
        #æ•°å­—æ›¿æ¢
        regex = re.compile("é›¶|ï¼|Âº|â°|Â°|â‚€|ï¼|â“ª|0âƒ£ï¸")
        text=re.sub(regex, "0",text)
        regex = re.compile("ä¸€|â‘ |â€|â‘´|â’ˆ|â¶|ãˆ |Â¹|â‚|ï¼‘|â™³|â“µ|I|1âƒ£ï¸")
        text=re.sub(regex, "1",text)
        regex = re.compile("äºŒ|â‘¡|â|â‘µ|â’‰|â·|ãˆ¡|Â²|â‚‚|ï¼’|â™´|â“¶|2âƒ£ï¸")
        text=re.sub(regex, "2",text)
        regex = re.compile("ä¸‰|â‘¢|â‚|â‘¶|â’Š|â¸|ãˆ¢|Â³|â‚ƒ|3|â™µ|â“·|3âƒ£ï¸")
        text=re.sub(regex, "3",text)
        regex = re.compile("å››|â‘£|âƒ|â‘·|â’‹|â¹|ãˆ£|â´|â‚„|ï¼”|â™¶|â“¸|4âƒ£ï¸")
        text=re.sub(regex, "4",text)
        regex = re.compile("äº”|â‘¤|â„|â‘¸|â’Œ|âº|ãˆ¤|âµ|â‚…|ï¼•|â™·|â“¹|5âƒ£ï¸")
        text=re.sub(regex, "5",text)
        regex = re.compile("å…­|â‘¥|â…|â‘¹|â’|â»|ãˆ¥|â¶|â‚†|6|â™¸|â“º|6âƒ£ï¸")
        text=re.sub(regex, "6",text)
        regex = re.compile("ä¸ƒ|â‘¦|â†|â‘º|â’|â¼|ãˆ¦|â·|â‚‡|ï¼—|â™¹|â“»|7âƒ£ï¸")
        text=re.sub(regex, "7",text)
        regex = re.compile("å…«|â‘§|â‡|â‘»|â’|â½|ãˆ§|â¸|â‚ˆ|ï¼˜|â“¼|8âƒ£ï¸")
        text=re.sub(regex, "8",text)
        regex = re.compile("ä¹|â‘¨|âˆ|â‘¼|â’|â¾|ãˆ¨|â¹|â‚‰|ï¼™|â“½|9âƒ£ï¸")
        text=re.sub(regex, "9",text)
        #ç½‘å€æ›¿æ¢
        regex = re.compile("((https?|ftp|news):\\/\\/)?([a-z0-9]([a-z0-9\\-]*[\\.ã€‚])+([a-z]{2}|aero|arpa|biz|com|coop|edu|gov|info|int|jobs|mil|museum|name|nato|net|org|pro|travel)|(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5]))(\\/[a-z0-9_\\-\\.~]+)*(\\/([a-z0-9_\\-\\.]*)(\\?[a-z0-9+_\\-\\.%=&]*)?)?(#[a-z][a-z0-9_]*)?")
        text=re.sub(regex, "ç½‘å€", text)
        #æ‰‹æœºå·æ›¿æ¢
        regex = re.compile("(13[0-9]|14[01456879]|15[0-35-9]|16[2567]|17[0-8]|18[0-9]|19[0-35-9])\\d{8}")
        text=re.sub(regex, "æ‰‹æœºå·", text)
        #é‚®ç®±æ›¿æ¢
        regex = re.compile("[*#\\u4e00-\\u9fa5 a-zA-Z0-9_.-]+@[a-zA-Z0-9-]+(\\.[a-zA-Z0-9-]+)*\\.[a-zA-Z0-9]{2,6}")
        text=re.sub(regex, "é‚®ç®±", text)
        #QQæ›¿æ¢
        regex = re.compile("[1-9]([0-9]{8,12})")
        patternFilter = r'(\d)\1{3,}|(?:01234|12345|23456|34567|45678|56789|98765|87654|76543|65432|54321|43210)'
        if re.search(patternFilter,text):
            tmp=""
        else:
            text=re.sub(regex, "QQ", text)
        #å¾®ä¿¡æ›¿æ¢

        # regex = re.compile("[a-zA-Z][a-zA-Z\d_-]{5,19}")
        # if text.find("hhhh")>-1 or text.find("aaaa")>-1 or text.find("xxxx")>-1:
        #     tmp = ""
        # else:
        #     text=re.sub(regex, "å¾®ä¿¡", text)

        #regex = re.compile(r'[a-zA-Z](?!([a-zA-Z\d])\1{3,})[a-zA-Z\d_-]{5,19}')
        #regex = re.compile("[a-zA-Z][a-zA-Z\d_-]{5,19}")
        regex = re.compile(r'^[a-zA-Z](?!.*(.)\1{3})(?=.*[\d_-])[a-zA-Z\d_-]{5,19}$')
        text = re.sub(regex, "å¾®ä¿¡", text)

        return text

    def specialBizCase(self,text):
        return self.strtr(text, {
            "ğŸ… ":"q","â“ ":"q","ğ•¢":"q","á‘«":"q","ğ":"q","Ç«":"q",
            "Ù©": "q","ğ‘„":"q","â„š":"q","ê":"q","kou":"q",
            "\\+":"åŠ ","â•":"åŠ ","add":"åŠ ","ï¼‹":"åŠ ","jia":"åŠ ",
            "mm":"å¦¹å¦¹","MM":"å¦¹å¦¹","é•é“":"ç¾å¥³","+":"åŠ ","yyds":"æ°¸è¿œçš„ç¥",
            "è‰¹":"æ“","åŠ v":"åŠ å¾®ä¿¡","kp":"ç£•ç‚®"

        })

    def extractWords(self,text):
        """æŠ½å‡ºä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—ï¼Œå¿½ç•¥æ ‡ç‚¹ç¬¦å·å’Œç‰¹æ®Šå­—ç¬¦ï¼ˆè¡¨æƒ…ï¼‰
        ä¸€èˆ¬ç”¨ä¸ååƒåœ¾
        """
        text = text.lower()  # è¯å‘é‡åªè®¡ç®—å°å†™
        text = self.specialBizCase(text)  # ç‰¹æ®Šä¸šåŠ¡å­—ç¬¦
        text = self.stopWordCase(text)  # å»æ‰åœç”¨è¯
        #text = self.simplify(text)  # ç¹ä½“è½¬ç®€ä½“--æ²¡å¿…è¦
        text = self.sbcCase(text)  # å…¨è§’è½¬åŠè§’
        text = self.circleCase(text)  # ç‰¹æ®Šå­—ç¬¦
        text = self.bracketCase(text)  # ç‰¹æ®Šå­—ç¬¦
        text = self.dotCase(text)  # ç‰¹æ®Šå­—ç¬¦
        text = self.specialCase(text)  # ç‰¹æ®Šå­—ç¬¦
        text = self.emojiCase(text)  # é¢œè¡¨æƒ…è½¬æ¢
        text = self.spaceCase(text)  # é¢œè¡¨æƒ…è½¬æ¢
        if self.isCut:
            if self.isZh:
                words = [item for item in jieba.cut(text, cut_all=False) if item not in [""," "]]
            else:
                words = text.strip().split()
        else:
            words=text
        return words


if __name__ == "__main__":
    inptStr="wxid_27636e7ytjoh12"
    textRe=TextRegularization()
    outputStr=textRe.extractWords(inptStr)
    print("è¾“å…¥ï¼š",inptStr,"\n")
    print("è¾“å‡ºï¼š", outputStr)




